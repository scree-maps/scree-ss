#!/usr/bin/env coffee

ENCODING = "utf8"

Package = require '../package.json'
Fs = require 'fs'
Parser = require '../compiled/source/parser'

CLI = require 'commander'
CLI.version(Package.version)
CLI.usage("[<input-screess>=stdin [<output-json>=stdout]]")
CLI.parse(process.argv)

inputStream = if CLI.args[0] then Fs.createReadStream(CLI.args[0]) else process.stdin
outputStream = if CLI.args[1] then Fs.createWriteStream(CLI.args[1]) else process.stdout

inputStream.on "error", (error) -> throw error
outputStream.on "error", (error) -> throw error

input = ""
inputStream.setEncoding(ENCODING)
inputStream.on "data", (chunk) -> input += chunk
inputStream.on "end", ->
  output = JSON.stringify(Parser.parse(input), null, 2) + "\n"

  if outputStream == process.stdout
    outputStream.write(output, ENCODING)
  else
    outputStream.end(output, ENCODING)

